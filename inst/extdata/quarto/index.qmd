---
title: "Organization-level Metrics and Models"
execute:
  echo: false
format:
  html:
    theme: yeti
---

```{r libraries, message = FALSE}
library (bslib)
library (bsicons)
library (htmltools)
library (plotly)
```

```{r valuebox-values}
repo_data <- readRDS ("results-data-repo-src.Rds")
num_repos <- nrow (repo_data)
repo_orgs <- gsub ("\\/.*$", "", repo_data$orgrepo) |>
    table () |>
    sort (decreasing = TRUE) |>
    head (n = 2L)
value1 <- 99
value2 <- 33
```

```{r sparkline-plot, echo = FALSE}
set.seed(4242)
random_sparkline_plot <- function() {
    timeseries <- cumsum (runif (100, -2, 2))
    x_axis <- seq_along (timeseries)
    x_lim <- range (x_axis)
    y_lim <- range (timeseries) + c (-2, 0)

    par(mar = c(2, 0, 0, 0))
    plot(
        timeseries,
        type = "n",
        axes = TRUE,
        frame.plot = FALSE,
        ylim = y_lim,
        xlim = x_lim,
        ylab = "",
        xlab = "",
        yaxs = "i",
        xaxs = "r"
    )

    lines(timeseries, type = "l", pch = NA, col = "#0B538E", lwd = 3)

    polygon_x <- c(1, x_axis, length(timeseries))
    polygon_y <- c(min(y_lim), timeseries, min(y_lim))

    polygon(polygon_x, polygon_y, col = "#e6f2fd", border = NA)
}
sparkline_plot <- function() {
    as_fill_item(
        htmltools::plotTag(
            random_sparkline_plot(),
            width = 500,
            height = 125,
            suppressSize = "xy",
            alt = paste(
                "A sparkline plot with a randomly-generated timeseries.",
                "The timeseries starts high and ends low, with lots of variation."
            )
        )
    )
}
```

:::{.grid}

::::{.g-col-12 .g-col-md-4}
```{r echo = FALSE, message = TRUE}
lines <- paste0 (unname (repo_orgs), " from ", names (repo_orgs))
bslib::value_box(
    title = "There are",
    value = paste0 (format (num_repos, big.mark = ","), " repositories"),
    showcase = bsicons::bs_icon("award"),
    theme = "bg-gradient-teal-orange",
    htmltools::p("including"),
    htmltools::p(bsicons::bs_icon("1-square"), lines [1]),
    htmltools::p(bsicons::bs_icon("2-square"), lines [2])
)
```
::::

::::{.g-col-12 .g-col-md-4}
```{r echo = FALSE, message = TRUE}
bslib::value_box(
    title = "First value is",
    htmltools::p("With a sparkline plot", bsicons::bs_icon("graph-up-arrow")),
    value = value1,
    showcase = sparkline_plot(),
    showcase_layout = "bottom",
    class = "border"
)
```
::::

::::{.g-col-12 .g-col-md-4}
```{r echo = FALSE, message = TRUE}
value_box(
  title = "KPI Title",
  h1(HTML("$1 <i>Billion</i> Dollars")),
  span(
    bsicons::bs_icon("arrow-up"),
    " 30% VS PREVIOUS 30 DAYS"
  ),
  showcase = bsicons::bs_icon("piggy-bank"),
  theme = "bg-gradient-red-yellow"
)
```
::::

:::

---

## Cards

```{r message = FALSE}
plotly_widget <- plot_ly(x = diamonds$cut) |>
    config(displayModeBar = FALSE) |>
    layout(margin = list(t = 0, b = 0, l = 0, r = 0))
linedat <- data.frame (x = 1:10, y = runif (10))
line_widget <- plot_ly(linedat, x = ~x, y = ~y) |>
    add_lines () |>
    config(displayModeBar = FALSE) |>
    layout(margin = list(t = 0, b = 0, l = 0, r = 0))
```

:::::{.grid}

::::{.g-col-12 .g-col-md-6}

```{r message = FALSE}
bslib::card(
    height = 375,
    full_screen = TRUE,
    card_header("A filling plot"),
    card_body(
        min_height = 200,
        plotly_widget
    ),
    card_body(
        class = "card-text",
        lorem::ipsum(paragraphs = 10, sentences = 5)
    )
)
```

::::

::::{.g-col-12 .g-col-md-6}

```{r}
bar_data <- data.frame (
    category = letters [1:5],
    value = round (runif (5, max = 100))
)
line_data <- data.frame (x = 1:10, y = runif (10))
```

```{r ojs-define}
ojs_define (barDataIn = bar_data)
ojs_define (lineDataIn = line_data)
```

```{ojs}
barData = {
    return transpose(barDataIn).map(row => ({
        ...row,
    }));
}
lineData = {
    return transpose(lineDataIn).map(row => ({
        ...row,
    }));
}
```

::: {.panel-tabset}

## Bar Plot

```{ojs}
Plot.plot({
    height: 375,
    marginLeft: 60,
    marginRight: 20,
    marginTop: 50,
    marginBottom: 10,
    axis: null,
    x: { grid: true, },
    y: { grid: true, },
    marks: [
        Plot.axisY({
            label: null,
            fontSize: 18,
            axis: "left"
        }),
        Plot.barY(barData, {
            y: "value",
            x: "category",
            sort: {y: "-x" },
            fill: "value",
        }),
        Plot.text(barData, {
            y: "value",
            x: "category",
            text: "category",
            fontSize: 24,
            dy: -15
        })
    ],
    color: {
        scheme: "Cool",
        type: "ordinal",
        reverse: false
    }
})
```

## Line Plot {.active}

```{ojs}
Plot.plot({
    height: 375,
    marginLeft: 60,
    marginRight: 20,
    marginTop: 50,
    marginBottom: 50,
    title: "This is a title",
    subtitle: "And this is a sub-title",
    x: { grid: true },
    y: { grid: true },
    marks: [
        Plot.axisX({
            axis: "bottom",
            label: null,
            fontSize: 18
        }),
        Plot.axisY({
            axis: "left",
            label: null,
            fontSize: 18
        }),
        Plot.lineY(lineData, {
            x: "x",
            y: "y",
            stroke: "orange",
            strokeWidth:  5,
        }),
        Plot.text([[1, 0]], {
                text: ["And here is some 'Plot.text' additional stuff"],
                lineWidth: 30, 
                textAnchor: "start",
                fontSize: 14,
                dy: 40
        }),
    ],
})
```

:::

::::

:::::

---

This dashboard presents metrics and models for each repository within both the
[`epiverse-trace`](https://github.com/epiverse-trace) and
[`reconhub`](https://github.com/reconhub) GitHub organizations. It is intended
to demonstrate the kinds of analyses and insights that are possible. It is
intended to change and develop a lot. Please provide feedback via GitHub by
clicking on the symbol on the top right.

The dashboard currently has three main pages:

1. An [organization maintenance](./chaoss-org.html) page identifying
   maintenance priorities across all repositories.
2. A [repository maintenance](./chaoss-repo.html) page providing additional
   detail on maintenance needs of a selected repository.
3. A [*Community Health*](./models.html) summarising scores for the various
   [CHAOSS (*Community Health Analytics in Open Source Software*)
    models and
    metrics](https://chaoss.community/kb-metrics-and-metrics-models/) for each
    repository.

There is also an additional [network diagram page](./network.html), showing
strengths of relationship between each repository.

